<p-toast></p-toast>

<div class="p-4 fadein animation-duration-500" *ngIf="lead; else loadingTemplate">
  <div class="mb-4">
    <h1 class="text-3xl font-bold m-0 text-900">Detalhes do Lead</h1>
    <div
      class="flex align-items-center gap-2 cursor-pointer text-600 hover:text-primary mt-2"
      (click)="goBack()"
    >
      <i class="pi pi-arrow-left text-sm"></i>
      <span>Voltar para Leads</span>
    </div>
  </div>

  <div class="lead-card mb-5">
    <div class="lead-header mb-3">
      <div class="lead-title">
        <i *ngIf="lead.isPriority" class="pi pi-star-fill priority-icon"></i>
        <h2 class="lead-name">{{ lead.name }}</h2>
        <p-tag
          [value]="lead.status"
          [severity]="getStatusSeverity(lead.status)"
          [rounded]="true"
        ></p-tag>
      </div>
    </div>

    <div class="lead-contacts">
      <span><i class="pi pi-map-marker"></i> {{ lead.city }}</span>
      <span><i class="pi pi-phone"></i> {{ lead.phone }}</span>
      <span><i class="pi pi-envelope"></i> {{ lead.email }}</span>
      <span>
        <i class="pi pi-calendar"></i>
        Criado em {{ lead.createdAt | date : 'dd/MM/yyyy' }}
      </span>
    </div>

    <div class="grid mt-4">
      <div class="col-12 md:col-3">
        <div class="info-box">
          <span class="info-label">CPF:</span>
          <span class="info-value">{{ lead.cpf }}</span>
        </div>
      </div>

      <div class="col-12 md:col-3">
        <div class="info-box">
          <span class="info-label">Área Total:</span>
          <span class="info-value">{{ lead.area }} ha</span>
        </div>
      </div>

      <div class="col-12 md:col-3">
        <div class="info-box">
          <span class="info-label">Propriedades:</span>
          <span class="info-value">{{ properties.length }}</span>
        </div>
      </div>

      <div class="col-12 md:col-3">
        <div class="info-box">
          <span class="info-label">Criado em:</span>
          <span class="info-value">
            {{ lead.createdAt | date : 'dd/MM/yyyy' }}
          </span>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <strong class="text-700 block mb-2">Comentários</strong>
      <div class="comments-box">
        <span *ngIf="lead.obs; else noObs">{{ lead.obs }}</span>
        <ng-template #noObs>
          <span class="text-500">Nenhuma observação registrada.</span>
        </ng-template>
      </div>
    </div>
  </div>

  <div *ngIf="properties.length">
    <div class="flex justify-content-between align-items-center mb-3">
      <h3 class="text-xl font-bold">Propriedades Rurais ({{ properties.length }})</h3>
    </div>

    <div class="properties-wrapper">
      <div class="map-header mb-4">
        <div class="map-title">Localização das Propriedades</div>
        <div id="mini-map" class="mini-map"></div>
      </div>

      <div class="grid">
        <div class="col-12 md:col-6" *ngFor="let prop of properties">
          <div class="property-card" [ngClass]="{ selected: selectedPropId === prop.id }">
            <div class="flex justify-content-between mb-2">
              <strong>{{ prop.name }}</strong>
            </div>

            <div class="property-meta">
              <span><i class="pi pi-map-marker"></i> {{ prop.city }}</span>
              <span><i class="pi pi-tag"></i> {{ prop.area }} ha</span>
            </div>

            <p-tag
              class="mt-2"
              [value]="prop.culture"
              [severity]="
                prop.culture === 'Soja' ? 'success' : prop.culture === 'Milho' ? 'warning' : 'info'
              "
            ></p-tag>

            <div class="property-obs" *ngIf="prop.obs">
              {{ prop.obs }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTemplate>
  <div
    class="flex flex-column align-items-center justify-content-center p-8"
    style="min-height: 400px"
  >
    <p-progressSpinner strokeWidth="3"></p-progressSpinner>
    <p class="text-600 font-medium mt-3">Carregando detalhes...</p>
  </div>
</ng-template>
